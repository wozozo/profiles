#!/bin/bash

# デフォルト値の設定
LINE_THRESHOLD=500
EXTENSIONS=()
TARGET_DIR="."
IGNORE_DIRS=()

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -t|--threshold)
            LINE_THRESHOLD="$2"
            shift 2
            ;;
        -t=*|--threshold=*)
            LINE_THRESHOLD="${1#*=}"
            shift
            ;;
        -e|--extensions)
            shift
            while [[ "$1" != "" && "$1" != -* ]]; do
                EXTENSIONS+=("$1")
                shift
            done
            ;;
        -e=*|--extensions=*)
            IFS=',' read -r -a tmp_ext <<< "${1#*=}"
            EXTENSIONS=("${tmp_ext[@]}")
            shift
            ;;
        -d|--directory)
            TARGET_DIR="$2"
            shift 2
            ;;
        -d=*|--directory=*)
            TARGET_DIR="${1#*=}"
            shift
            ;;
        -i|--ignore)
            shift
            while [[ "$1" != "" && "$1" != -* ]]; do
                IGNORE_DIRS+=("$1")
                shift
            done
            ;;
        -i=*|--ignore=*)
            IFS=',' read -r -a tmp_ignore <<< "${1#*=}"
            IGNORE_DIRS=("${tmp_ignore[@]}")
            shift
            ;;
        -h|--help)
            echo "loc - Lines of Code scanner"
            echo ""
            echo "Usage: loc [OPTIONS]"
            echo ""
            echo "指定した行数以上のファイルを検索し、行数順に表示します。"
            echo ""
            echo "Options:"
            echo "  -t, --threshold NUM     行数の閾値を指定 (デフォルト: 500)"
            echo "  -e, --extensions EXT    対象拡張子を指定 (例: .tsx .ts)"
            echo "  -d, --directory DIR     検索対象ディレクトリ (デフォルト: .)"
            echo "  -i, --ignore DIR        無視するディレクトリ (例: node_modules)"
            echo "  -h, --help              このヘルプを表示"
            echo ""
            echo "Examples:"
            echo "  loc                              # 500行以上のファイルを表示"
            echo "  loc -t 100                       # 100行以上のファイルを表示"
            echo "  loc -t 100 -e .tsx .ts           # TypeScriptファイルのみ"
            echo "  loc -d ./src -i ./src/generated  # srcディレクトリでgeneratedを除外"
            echo ""
            echo "Default extensions:"
            echo "  .js .jsx .ts .tsx .py .java .cpp .c .h .go .rs"
            echo ""
            echo "Default ignore directories:"
            echo "  node_modules .git dist build coverage __pycache__ .pytest_cache"
            exit 0
            ;;
        *)
            echo "loc: 不明なオプション '$1'"
            echo "詳細は 'loc --help' を参照してください。"
            exit 1
            ;;
    esac
done

# 拡張子が指定されていない場合のデフォルト
if [ ${#EXTENSIONS[@]} -eq 0 ]; then
    EXTENSIONS=(".js" ".jsx" ".ts" ".tsx" ".py" ".java" ".cpp" ".c" ".h" ".go" ".rs")
fi

# 無視するディレクトリのデフォルト設定
if [ ${#IGNORE_DIRS[@]} -eq 0 ]; then
    IGNORE_DIRS=("node_modules" ".git" "dist" "build" "coverage" "__pycache__" ".pytest_cache")
fi

# ディレクトリの存在確認
if [ ! -d "$TARGET_DIR" ]; then
    echo "エラー: ディレクトリ '$TARGET_DIR' が存在しません"
    exit 1
fi

# ファイル検索と行数カウント
echo "LOC Scanner - Lines of Code"
echo "検索対象: $TARGET_DIR"
echo "閾値: ${LINE_THRESHOLD}行以上"
echo "拡張子: ${EXTENSIONS[@]}"
echo "除外: ${IGNORE_DIRS[@]}"
echo "----------------------------------------"

# find用の除外パターンを構築
FIND_PRUNE=""
for ignore_dir in "${IGNORE_DIRS[@]}"; do
    if [ -n "$FIND_PRUNE" ]; then
        FIND_PRUNE="$FIND_PRUNE -o"
    fi
    FIND_PRUNE="$FIND_PRUNE -path '*/$ignore_dir' -prune"
done

# 拡張子パターンを構築
FIND_NAME=""
for ext in "${EXTENSIONS[@]}"; do
    if [ -n "$FIND_NAME" ]; then
        FIND_NAME="$FIND_NAME -o"
    fi
    FIND_NAME="$FIND_NAME -name '*${ext}'"
done

# findコマンドを実行し、xargsでwcを並列実行
if [ -n "$FIND_PRUNE" ]; then
    eval "find \"$TARGET_DIR\" $FIND_PRUNE -o -type f \\( $FIND_NAME \\) -print0" | \
    xargs -0 -P 8 wc -l 2>/dev/null | \
    awk -v threshold="$LINE_THRESHOLD" '{
        if ($1 >= threshold && $2 != "total") {
            printf "%-60s %6d 行\n", $2, $1
        }
    }' | sort -k2 -nr
else
    eval "find \"$TARGET_DIR\" -type f \\( $FIND_NAME \\) -print0" | \
    xargs -0 -P 8 wc -l 2>/dev/null | \
    awk -v threshold="$LINE_THRESHOLD" '{
        if ($1 >= threshold && $2 != "total") {
            printf "%-60s %6d 行\n", $2, $1
        }
    }' | sort -k2 -nr
fi